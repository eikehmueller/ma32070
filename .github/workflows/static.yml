name: Convert markdown to html
on: [push]
concurrency:
  group: "pages"
  cancel-in-progress: false
jobs:
    convert_via_pandoc:
        name: Convert markdown to html
        permissions:
          pages: write  
          id-token: write
          actions: read
          contents: read
        environment:
          name: github-pages
          url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        steps:
            - name: Check out pandoc templates
              uses: actions/checkout@v4
              with:
                repository: ryangrose/easy-pandoc-templates
                ref: '80d5aa611ceaee12cd55ac344a1e19cfb7781d14'
                path: easy-pandoc-templates
            - run: |                
                cp easy-pandoc-templates/html/uikit.html ~/uikit.html
            - name: Check out repository
              uses: actions/checkout@v4
            - run: |
                cp ~/uikit.html .
            - name: Convert index markdown to html with pandoc
              uses: docker://pandoc/latex:3.7.0.2
              with:
                args: >- 
                    --standalone
                    --mathjax
                    --to html
                    --output index.html
                    --metadata-file metadata.yml
                    index.md
            - run: |
                python3 lectures/parse_crossreferences.py lectures/Notes.md > lectures/_Notes.md
            - name: Convert lecture markdown to html with pandoc
              uses: docker://pandoc/latex:3.7.0.2
              with:
                args: >- 
                    --standalone
                    --toc
                    --mathjax
                    --to html
                    --output notes.html
                    --resource-path lectures
                    --metadata-file metadata.yml
                    --template uikit.html
                    lectures/_Notes.md
            - name: Convert Exercises markdown to html with pandoc
              uses: docker://pandoc/latex:3.7.0.2               
              with:
                args: >- 
                  --standalone
                  --mathjax
                  --toc
                  --to html
                  --output exercises.html
                  --template uikit.html
                  --resource-path exercises
                  --metadata-file metadata.yml
                  lectures/Exercises.md
            - name: Convert prerequisites markdown to html with pandoc
              uses: docker://pandoc/latex:3.7.0.2              
              with:
                args: >- 
                  --standalone
                  --mathjax
                  --toc
                  --to html
                  --output prerequisites.html
                  --template uikit.html
                  --resource-path generalinformation
                  --metadata-file metadata.yml
                  generalinformation/Prerequisites.md
            - name: Convert setup instructions markdown to html with pandoc
              uses: docker://pandoc/latex:3.7.0.2                
              with:
                args: >- 
                  --standalone
                  --mathjax
                  --toc
                  --to html
                  --output setup.html
                  --template uikit.html
                  --resource-path generalinformation
                  --metadata-file metadata.yml
                  generalinformation/Setup.md
            - name: Convert model solution exercise 1 markdown to html with pandoc
              uses: docker://pandoc/latex:3.7.0.2                
              with:
                args: >- 
                  --standalone
                  --mathjax
                  --toc
                  --to html
                  --output model_solution_exercise_finiteelement.html
                  --template uikit.html
                  --resource-path solutions/exercise_finiteelement
                  --metadata-file metadata.yml
                  solutions/exercise_finiteelement/Solution.md
            - name: Convert model solution exercise 2 markdown to html with pandoc
              uses: docker://pandoc/latex:3.7.0.2                
              with:
                args: >- 
                  --standalone
                  --mathjax
                  --toc
                  --to html
                  --output model_solution_exercise_localassembly.html
                  --template uikit.html
                  --resource-path solutions/exercise_localassembly
                  --metadata-file metadata.yml
                  solutions/exercise_localassembly/Solution.md
            - name: Convert model solution bonus exercise markdown to html with pandoc
              uses: docker://pandoc/latex:3.7.0.2                
              with:
                args: >- 
                  --standalone
                  --mathjax
                  --toc
                  --to html
                  --output model_solution_exercise_quadrature.html
                  --template uikit.html
                  --resource-path solutions/exercise_quadrature
                  --metadata-file metadata.yml
                  solutions/exercise_quadrature/Solution.md
            - name: Convert model solution exercise 3 markdown to html with pandoc
              uses: docker://pandoc/latex:3.7.0.2                
              with:
                args: >- 
                  --standalone
                  --mathjax
                  --toc
                  --to html
                  --output model_solution_global_error.html
                  --template uikit.html
                  --resource-path solutions/exercise_global_error
                  --metadata-file metadata.yml
                  solutions/exercise_global_error/Solution.md
            - name: Convert model solution exercise 4 markdown to html with pandoc
              uses: docker://pandoc/latex:3.7.0.2                
              with:
                args: >- 
                  --standalone
                  --mathjax
                  --toc
                  --to html
                  --output model_solution_complexity.html
                  --template uikit.html
                  --resource-path solutions/exercise_complexity
                  --metadata-file metadata.yml
                  solutions/exercise_complexity/Solution.md
            - name: Convert model solution exercise 5 markdown to html with pandoc
              uses: docker://pandoc/latex:3.7.0.2                
              with:
                args: >- 
                  --standalone
                  --mathjax
                  --toc
                  --to html
                  --output model_solution_exercise_petsc.html
                  --template uikit.html
                  --resource-path solutions/exercise_petsc
                  --metadata-file metadata.yml
                  solutions/exercise_petsc/Solution.md
            - name: Copy to deployment folder
              run: |
                    mkdir docs
                    mv index.html docs
                    mv setup.html docs
                    mv prerequisites.html docs
                    mv notes.html docs
                    mv exercises.html docs
                    cp -r lectures/figures docs
                    # EXERCISE 1
                    mv model_solution_exercise_finiteelement.html docs
                    cp solutions/exercise_finiteelement/cubicelement.py docs
                    cp solutions/exercise_finiteelement/test_cubicelement.py docs
                    # EXERCISE 2
                    mv model_solution_exercise_localassembly.html docs
                    cp solutions/exercise_localassembly/algorithms.py docs
                    cp solutions/exercise_localassembly/driver.py docs
                    cp solutions/exercise_localassembly/triangle_solution_??.png docs
                    # BONUS EXERCISE
                    mv model_solution_exercise_quadrature.html docs
                    cp solutions/exercise_quadrature/threepointquadrature.py docs
                    cp solutions/exercise_quadrature/test_threepointquadrature.py docs
                    # EXERCISE 3
                    mv model_solution_exercise_global_error.html docs
                    cp solutions/exercise_global_error/algorithms.py docs
                    cp solutions/exercise_global_error/driver.py docs
                    cp solutions/exercise_global_error/convergence.png docs
                    # EXERCISE 4
                    mv model_solution_exercise_complexity.html docs
                    # EXERCISE 5
                    mv model_solution_exercise_petsc.html docs
                    cp solutions/exercise_petsc/*.svg docs
                    cp solutions/exercise_petsc/linear_algebra.py docs
                    cp solutions/exercise_petsc/linear_solve.py docs
            - name: Upload artifacts
              uses: actions/upload-pages-artifact@v3
              with:
                path: './docs/'
                name: github-pages
            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
